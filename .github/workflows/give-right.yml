name: Give Voting Right

on:
  workflow_dispatch:
    inputs:
      walletAddress:
        description: "Wallet address to grant voting rights"
        required: true
        type: string
      chainId:
        description: "Chain ID"
        required: false
        type: string
      requestTimestamp:
        description: "Request timestamp"
        required: false
        type: string

jobs:
  give-voting-rights:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install ethers

      - name: Grant voting rights
        env:
          PRIVATE_KEY: ${{ secrets.ADMIN_PRIVATE_KEY }}
          RPC_URL: ${{ secrets.RPC_URL }}
          CONTRACT_ADDRESS: ${{ secrets.CONTRACT_ADDRESS }}
          WALLET_ADDRESS: ${{ github.event.inputs.walletAddress }}
          CHAIN_ID: ${{ github.event.inputs.chainId }}
        run: |
          node -e "
          const { ethers } = require('ethers');

          async function grantVotingRights() {
            try {
              console.log('ğŸ”„ é–‹å§‹æˆäºˆæŠ•ç¥¨æ¬Š...');
              console.log('ç›®æ¨™éŒ¢åŒ…åœ°å€:', process.env.WALLET_ADDRESS);
              console.log('éˆ ID:', process.env.CHAIN_ID);
              
              const provider = new ethers.JsonRpcProvider(process.env.RPC_URL);
              const adminWallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
              
              console.log('ç®¡ç†å“¡éŒ¢åŒ…åœ°å€:', adminWallet.address);
              
              const contractABI = [
                'function giveRightToVote(address voter) external',
                'function hasVotingRight(address voter) external view returns (bool)'
              ];
              
              const contract = new ethers.Contract(
                process.env.CONTRACT_ADDRESS, 
                contractABI, 
                adminWallet
              );
              
              // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²æœ‰æŠ•ç¥¨æ¬Š
              const hasRights = await contract.hasVotingRight(process.env.WALLET_ADDRESS);
              if (hasRights) {
                console.log('âœ… ç”¨æˆ¶å·²ç¶“æ“æœ‰æŠ•ç¥¨æ¬Š');
                return;
              }
              
              // æˆäºˆæŠ•ç¥¨æ¬Š
              console.log('ğŸ“ æ­£åœ¨æˆäºˆæŠ•ç¥¨æ¬Š...');
              const tx = await contract.giveRightToVote(process.env.WALLET_ADDRESS);
              console.log('äº¤æ˜“å“ˆå¸Œ:', tx.hash);
              
              console.log('â³ ç­‰å¾…äº¤æ˜“ç¢ºèª...');
              const receipt = await tx.wait();
              
              console.log('âœ… æŠ•ç¥¨æ¬ŠæˆäºˆæˆåŠŸï¼');
              console.log('å€å¡Šé«˜åº¦:', receipt.blockNumber);
              console.log('Gas ä½¿ç”¨é‡:', receipt.gasUsed.toString());
              
            } catch (error) {
              console.error('âŒ æˆäºˆæŠ•ç¥¨æ¬Šå¤±æ•—:', error.message);
              process.exit(1);
            }
          }

          grantVotingRights();
          "
