name: Give Voting Right

on:
  workflow_dispatch:
    inputs:
      walletAddress:
        description: "Wallet address to grant voting rights"
        required: true
        type: string
      chainId:
        description: "Chain ID"
        required: false
        type: string
      requestTimestamp:
        description: "Request timestamp"
        required: false
        type: string

jobs:
  give-voting-rights:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install ethers

      - name: Grant voting rights
        env:
          PRIVATE_KEY: ${{ secrets.ADMIN_PRIVATE_KEY }}
          RPC_URL: ${{ secrets.RPC_URL }}
          CONTRACT_ADDRESS: ${{ secrets.CONTRACT_ADDRESS }}
          WALLET_ADDRESS: ${{ github.event.inputs.walletAddress }}
          CHAIN_ID: ${{ github.event.inputs.chainId }}
        run: |
          node -e "
          const { ethers } = require('ethers');

          async function grantVotingRights() {
            try {
              console.log('🔄 開始授予投票權...');
              console.log('目標錢包地址:', process.env.WALLET_ADDRESS);
              console.log('鏈 ID:', process.env.CHAIN_ID);
              
              const provider = new ethers.JsonRpcProvider(process.env.RPC_URL);
              const adminWallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
              
              console.log('管理員錢包地址:', adminWallet.address);
              
              const contractABI = [
                'function giveRightToVote(address voter) external',
                'function hasVotingRight(address voter) external view returns (bool)'
              ];
              
              const contract = new ethers.Contract(
                process.env.CONTRACT_ADDRESS, 
                contractABI, 
                adminWallet
              );
              
              // 檢查用戶是否已有投票權
              const hasRights = await contract.hasVotingRight(process.env.WALLET_ADDRESS);
              if (hasRights) {
                console.log('✅ 用戶已經擁有投票權');
                return;
              }
              
              // 授予投票權
              console.log('📝 正在授予投票權...');
              const tx = await contract.giveRightToVote(process.env.WALLET_ADDRESS);
              console.log('交易哈希:', tx.hash);
              
              console.log('⏳ 等待交易確認...');
              const receipt = await tx.wait();
              
              console.log('✅ 投票權授予成功！');
              console.log('區塊高度:', receipt.blockNumber);
              console.log('Gas 使用量:', receipt.gasUsed.toString());
              
            } catch (error) {
              console.error('❌ 授予投票權失敗:', error.message);
              process.exit(1);
            }
          }

          grantVotingRights();
          "
